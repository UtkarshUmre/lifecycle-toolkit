apiVersion: kuttl.dev/v1alpha1
kind: TestAssert

collectors:
  - type: pod
    selector: app=some-keptn-app1
  - type: pod
    selector: app=some-keptn-app-version-1
  - type: pod
    selector: app=my-metric-2
  - type: pod
    selector: app=slack-deployment-notification
  - type: pod
    selector: app=lifecycle-operator
  - type: pod
    selector: app=metrics-operator
commands:
  - command: kubectl describe keptnworkloadversion -n $NAMESPACE
  - command: kubectl describe keptnappversion -n $NAMESPACE
  - command: kubectl describe keptntask slack-deployment-notification -n $NAMESPACE
  - command: kubectl logs -l control-plane=lifecycle-operator -n keptn-system
  - command: kubectl logs -l app=metrics-operator -n keptn-system

---
apiVersion: lifecycle.keptn.sh/v1beta1
kind: KeptnApp
metadata:
  name: "some-keptn-app1"
spec:
  version: "1.2.3"
  revision: 1
---
apiVersion: lifecycle.keptn.sh/v1beta1
kind: KeptnAppVersion
metadata:
  name: "some-keptn-app-version-1"
spec:
  appName: podtato-head
  revision: 1
  preDeploymentTasks:
    - pre-deployment-task
  preDeploymentEvaluations:
    - pre-deployment-evaluation
  postDeploymentTasks:
    - post-deployment-task
  postDeploymentEvaluations:
    - post-deployment-evaluation
  traceId:
    traceparent: my-trace-parent
  version: 0.1.0
  workloads:
    - name: podtato-head-left-arm
      version: 0.2.7
---
apiVersion: metrics.keptn.sh/v1beta1
kind: KeptnMetric
metadata:
  name: my-metric-2
spec:
  fetchIntervalSeconds: 60
  provider:
    name: prometheus
  query: "sum(kube_pod_container_resource_limits{resource='cpu'})"
---
apiVersion: lifecycle.keptn.sh/v1beta1
kind: KeptnTask
metadata:
  name: slack-deployment-notification
spec:
  taskDefinition: slack-notification-inline
  context:
    workloadName: my-workload
    workloadVersion: "1.0"
    taskType: "pre"
    appName: "my-app"
    objectType: "App"
    appVersion: "1.0"
  secureParameters:
    secret: slack-notification
